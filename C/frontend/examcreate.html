<!DOCTYPE html>
<html>
<head>
    <title>Create Exam</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="../frontend/css/bootstrap.min.css">
    <link rel="stylesheet" href="examcreate.css">
</head>
<body class="ExamForm">
    <div id="examForm" class="m-3 ExamForm1">
        <input type="text" id="examName" placeholder="Exam Name" class="m-3">
        <input type="date" id="examDate" class="m-3">
        <input type="number" id="questionCount" placeholder="Question Count" class="m-3">
        <input type="number" id="maxMarks" placeholder="Max Marks" class="m-3">
        <button id="createExam" class="m-3 button2 btn-primary btn submit">Create Exam</button>
    </div>
    <div id="keyForm" style="display: none;" class="key">
        <button id="submitAnswerKey" class="m-3 form-control p-2 btn btn-primary submit button1">Submit Answer Key</button>
    </div>
    <div id="ansForm" style="display: none;" >
        <div class="m-3 ExamForm2">
            Student Id : 
            <input type="text" id="student"> 
            <input type="file" id="pdf">
            <button class="submitAnswer">+</button>
        </div>
    </div>


    <script>

        $(document).ready(function() {

            var jwt = sessionStorage.getItem("jwt");
            console.log(jwt);

            $("#createExam").click(function() {

                // get all the necessary data to send request
                var examData = {
                    "name": $("#examName").val(),
                    "date": $("#examDate").val(),
                    "qstn_count": $("#questionCount").val(),
                    "max_marks": $("#maxMarks").val()
                }

                // send post request to backend
                $.ajax({
                    url: 'http://127.0.0.1:8000/exam/create',
                    type: 'post',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify(examData),                    
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader("Authorization", "Bearer " + jwt);
                    },
                    success: function(data) {
                        console.log(data);
                        sessionStorage.setItem("table_name", data.table_name);
                        // $("#keyForm").show(); and dynamically create form should actually come here
                    }
                });

                $("#keyForm").show();

                // dynamically create form based on question count 
                for (let i = $("#questionCount").val()-1; i >=0; i--) {
                    $("#keyForm").prepend(` 
                        <div class="m-3 ExamForm2">
                        Question ${i+1}:<br>
                        Answer : <br><textarea row="10" type="text" id="ans${i+1}" class="ans1"></textarea> <br><br>
                        Marks : <br><input type="number" id="mark${i+1}"> <br>
                        <div/>
                    `);
                 
                }
    
            });
        

            
            $("#submitAnswerKey").click(function() {

                // get all the necessary data to send request
                var table_name = sessionStorage.getItem("table_name");
                var answerKeyData = {};
                for (let i = 0; i < $("#questionCount").val(); i++) {
                    answerKeyData["ans" + (i + 1)] = $("#ans" + (i + 1)).val();
                    answerKeyData["mark" + (i + 1)] = parseInt($("#mark" + (i + 1)).val(), 10);
                }
                //console.log(answerKeyData);

                // send post request to backend
                $.ajax({
                    url: 'http://127.0.0.1:8000/exam/anskey/' + table_name,
                    type: 'post',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify(answerKeyData),
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader("Authorization", "Bearer " + jwt);
                    },
                    success: function(data) {
                        console.log(data);
                        // remove keyForm and show answForm should be here
                    }
                });

                // remove keyForm and show ansForm
                $("#keyForm").hide();
                $("#ansForm").show();

            });

            $(document).on('click', '.submitAnswer', function() {

                // get all the necessary data to send request

                // send post request to backend

                // if success hide previous submitAnswer buttons and add next form
                $(".submitAnswer").hide();
                function generateForm() {
                    return `
                    <div class="m-3 ExamForm2">
                        Student Id : 
                        <input type="text" id="student">
                        <input type="file" id="pdf">
                        <button class="submitAnswer">+</button>
                    </div>    
                    `;
                }
                $("#ansForm").append(generateForm());

            });

        });

    
    </script>
</body>
</html>